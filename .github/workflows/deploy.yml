name: Deploy Patch

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g. 1.2.0)"
        required: true
        default: "1.0.0"
      build_id:
        description: "Build identifier (e.g. build123)"
        required: true
        default: "build000"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.inputs.version || '1.0.0' }}
      BUILD_ID: ${{ github.event.inputs.build_id || 'build000' }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Build patcher
      run: cd tools/patcher && cargo build --release

    - name: Generate patch
      run: |
        cd tools/patcher
        ./target/release/patcher \
          CanartWorks \
          stable \
          "${{ env.VERSION }}" \
          "${{ env.BUILD_ID }}" \
          "../releases/build_outputs/${{ env.VERSION }}"

    - name: Upload to patch server
      run: |
        # Example using scp; replace with rsync or SSH action as needed
        scp -o StrictHostKeyChecking=no -r releases/manifests/* root@31.57.154.32:/var/www/patcher/manifests/
        scp -o StrictHostKeyChecking=no -r releases/channels/* root@31.57.154.32:/var/www/patcher/channels/
        scp -o StrictHostKeyChecking=no -r releases/build_outputs/${{ env.VERSION }}/* root@31.57.154.32:/var/www/patcher/files/${{ env.VERSION }}/

    - name: Validate deployment
      run: |
        echo "Validate manifest and file URLs for version $VERSION"
