name: Deploy Patch

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g. 1.2.0)"
        required: true
        default: "1.0.0"
      build_id:
        description: "Build identifier (e.g. build123)"
        required: true
        default: "build000"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.inputs.version || '1.0.0' }}
      BUILD_ID: ${{ github.event.inputs.build_id || 'build000' }}

    steps:
    - uses: actions/checkout@v4

    - name: Install system deps (GTK/WebKit)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          webkit2gtk-4.1 \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          libsoup2.4-dev

    - name: Set up Node
      uses: actions/setup-node@v4
      with:
        node-version: '20.19.0'

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install frontend deps
      run: |
        cd launcher
        npm install

    - name: Build patcher
      run: cd tools/patcher && cargo build --release

    - name: Generate patch
      run: |
        cd tools/patcher
        ./target/release/patcher \
          CanartWorks \
          stable \
          "${{ env.VERSION }}" \
          "${{ env.BUILD_ID }}" \
          "../releases/build_outputs/${{ env.VERSION }}"

    - name: Build Tauri bundles
      run: |
        cd launcher
        npm run tauri build

    - name: Upload Tauri artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tauri-bundles-${{ env.VERSION }}
        path: launcher/src-tauri/target/release/bundle/**/*

    - name: Publish GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ env.VERSION }}
        name: CanartWorks Launcher v${{ env.VERSION }}
        body: |
          Automated build for version ${{ env.VERSION }} (build ID: ${{ env.BUILD_ID }}).
          Bundles include MSI/NSIS installers and other Tauri artifacts.
        files: launcher/src-tauri/target/release/bundle/**/*
        draft: false
        prerelease: false

    - name: Validate deployment
      run: |
        echo "Artifacts ready under releases/ for version $VERSION. Deploy manually via tools/deployer CLI."
